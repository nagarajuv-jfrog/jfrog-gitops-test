# Optional: run a full integration test (kind + Argo CD + deploy evaluation app).
# Trigger manually to verify the evaluation example deploys and syncs.
# Requires: Docker (available on GitHub-hosted runners). Image pulls from
# releases-docker.jfrog.io may require auth in private environments.
name: Integration (kind + Argo CD)

on:
  workflow_dispatch: {}

jobs:
  integration:
    name: kind + Argo CD + JFrog Platform (evaluation)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kind and kubectl
        run: |
          set -e
          curl -fsSL -o ./kind "https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64"
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind
          KUBECTL_VER=$(curl -sL https://dl.k8s.io/release/stable.txt)
          curl -fsSL -o ./kubectl "https://dl.k8s.io/release/${KUBECTL_VER}/bin/linux/amd64/kubectl"
          chmod +x ./kubectl && sudo mv ./kubectl /usr/local/bin/kubectl
          kind --version && kubectl version --client

      - name: Create kind cluster and set kubeconfig
        run: |
          set -e
          kind create cluster --wait 120s --image kindest/node:v1.28.0
          kind get kubeconfig > "$GITHUB_WORKSPACE/kubeconfig"
          echo "KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig" >> "$GITHUB_ENV"
          chmod 600 "$GITHUB_WORKSPACE/kubeconfig"
          kubectl cluster-info

      - name: Install Argo CD (excluding ApplicationSet CRD to avoid 262144-byte annotation limit)
        run: |
          set -e
          kubectl create namespace argocd
          curl -fsSL -o install.yaml "https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
          curl -fsSL -o yq "https://github.com/mikefarah/yq/releases/download/v4.35.1/yq_linux_amd64"
          chmod +x yq && sudo mv yq /usr/local/bin/yq
          yq eval-all 'select(.kind != "CustomResourceDefinition" or .metadata.name != "applicationsets.argoproj.io")' install.yaml > install-filtered.yaml
          echo "Skipped applicationsets.argoproj.io CRD (annotation size limit)."
          kubectl apply -n argocd -f install-filtered.yaml
          kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s

      - name: Apply evaluation Application
        run: |
          set -e
          kubectl apply -f examples/evaluation/argocd-app.yaml

      - name: Wait for Application Synced (timeout 10 min)
        run: |
          set -e
          for i in $(seq 1 120); do
            status=$(kubectl get application jfrog-platform -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            echo "[$i/120] Sync status: $status"
            if [[ "$status" == "Synced" ]]; then
              echo "Application is Synced."
              exit 0
            fi
            if [[ $i -eq 120 ]]; then
              echo "Timeout waiting for Synced. Last status: $status"
              kubectl get application jfrog-platform -n argocd -o yaml || true
              exit 1
            fi
            sleep 5
          done

      - name: Show Application and pods
        if: always()
        run: |
          kubectl get application -n argocd 2>/dev/null || true
          kubectl get pods -n jfrog-platform 2>/dev/null || true
