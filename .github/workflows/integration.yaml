# Optional: run a full integration test (kind + Argo CD + deploy evaluation app).
# Trigger manually to verify the evaluation example deploys and syncs.
# Requires: Docker (available on GitHub-hosted runners). Image pulls from
# releases-docker.jfrog.io may require auth in private environments.
name: Integration (kind + Argo CD)

on:
  workflow_dispatch: {}

jobs:
  integration:
    name: kind + Argo CD + JFrog Platform (evaluation)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kind and kubectl
        run: |
          set -e
          curl -fsSL -o ./kind "https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64"
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind
          KUBECTL_VER=$(curl -sL https://dl.k8s.io/release/stable.txt)
          curl -fsSL -o ./kubectl "https://dl.k8s.io/release/${KUBECTL_VER}/bin/linux/amd64/kubectl"
          chmod +x ./kubectl && sudo mv ./kubectl /usr/local/bin/kubectl
          kind --version && kubectl version --client

      - name: Create kind cluster and set kubeconfig
        run: |
          set -e
          kind create cluster --wait 120s --image kindest/node:v1.28.0
          kind get kubeconfig > "$GITHUB_WORKSPACE/kubeconfig"
          echo "KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig" >> "$GITHUB_ENV"
          chmod 600 "$GITHUB_WORKSPACE/kubeconfig"
          kubectl cluster-info

      - name: Install Argo CD
        run: |
          set -e
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          kubectl wait --for=condition=Ready pods --all -n argocd --timeout=300s

      - name: Apply evaluation Application
        run: |
          set -e
          kubectl apply -f examples/evaluation/argocd-app.yaml

      - name: Wait for Application Synced (timeout 10 min)
        run: |
          set -e
          for i in $(seq 1 120); do
            status=$(kubectl get application jfrog-platform -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "Unknown")
            echo "[$i/120] Sync status: $status"
            if [[ "$status" == "Synced" ]]; then
              echo "Application is Synced."
              exit 0
            fi
            # Every 20 polls, dump OutOfSync resources for debugging
            if [[ $((i % 20)) -eq 0 ]]; then
              echo "--- OutOfSync resources (sample) ---"
              kubectl get application jfrog-platform -n argocd -o json 2>/dev/null \
                | jq -r '.status.resources[]? | select(.status == "OutOfSync") | "\(.kind)/\(.name): \(.message // "")"' 2>/dev/null || true
            fi
            if [[ $i -eq 120 ]]; then
              echo "Timeout waiting for Synced. Last status: $status"
              echo "--- Full Application status ---"
              kubectl get application jfrog-platform -n argocd -o yaml || true
              echo "--- OutOfSync resources ---"
              kubectl get application jfrog-platform -n argocd -o json 2>/dev/null \
                | jq -r '.status.resources[]? | select(.status == "OutOfSync") | "\(.group // "")/\(.kind)/\(.name): \(.message // "")"' 2>/dev/null || true
              exit 1
            fi
            sleep 5
          done

      - name: Show Application and pods
        if: always()
        run: |
          kubectl get application -n argocd 2>/dev/null || true
          kubectl get pods -n jfrog-platform 2>/dev/null || true
