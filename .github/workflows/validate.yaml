# Validate YAML, Helm templates, and scripts on every push and PR.
# No cluster required; runs in ~1-2 min.
name: Validate

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  yaml:
    name: YAML lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint argocd-app.yaml customvalues.yaml
          yamllint examples/
          yamllint .github/workflows/

  helm:
    name: Helm template
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.13.0"

      - name: Add JFrog Helm repo
        run: |
          helm repo add jfrog https://charts.jfrog.io
          helm repo update jfrog
          helm search repo jfrog/jfrog-platform --versions | head -5

      # Pin chart version for reproducibility; update when upgrading examples.
      # No --validate: that flag contacts a Kubernetes API server; this job has no cluster.
      - name: Template root (customvalues.yaml)
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            --version "11.4.0" \
            -f customvalues.yaml \
            --namespace jfrog-platform

      - name: Template examples/evaluation
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            --version "11.4.0" \
            -f examples/evaluation/customvalues.yaml \
            --namespace jfrog-platform

      - name: Template examples/production
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            --version "11.4.0" \
            -f examples/production/customvalues.yaml \
            --namespace jfrog-platform

      - name: Template examples/eks
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            --version "11.4.0" \
            -f examples/eks/customvalues.yaml \
            --namespace jfrog-platform

      - name: Template examples/openshift
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            --version "11.4.0" \
            -f examples/openshift/customvalues.yaml \
            --namespace jfrog-platform

      - name: Template examples/multi-source (base + sizing)
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            --version "11.4.0" \
            -f examples/multi-source/customvalues.yaml \
            -f examples/multi-source/sizing/platform-medium.yaml \
            --namespace jfrog-platform

  scripts:
    name: Shell scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check script syntax (bash -n)
        run: |
          shopt -s nullglob
          for f in scripts/*.sh; do
            bash -n "$f" || { echo "Syntax error in $f"; exit 1; }
          done
          echo "All scripts passed syntax check."

      - name: Run ShellCheck (optional)
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq shellcheck
          shellcheck scripts/*.sh || true
          # Don't fail on ShellCheck warnings; fix over time. Remove "|| true" to enforce.

  kubectl-dry-run:
    name: Argo CD manifests (kubectl dry-run)
    runs-on: ubuntu-latest
    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig
    steps:
      - uses: actions/checkout@v4

      - name: Install kind and kubectl
        run: |
          set -e
          curl -fsSL -o ./kind "https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64"
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind
          KUBECTL_VER=$(curl -sL https://dl.k8s.io/release/stable.txt)
          curl -fsSL -o ./kubectl "https://dl.k8s.io/release/${KUBECTL_VER}/bin/linux/amd64/kubectl"
          chmod +x ./kubectl && sudo mv ./kubectl /usr/local/bin/kubectl
          kind --version && kubectl version --client

      - name: Create kind cluster
        run: |
          set -e
          kind create cluster --wait 120s --image kindest/node:v1.28.0
          kind get kubeconfig > "$GITHUB_WORKSPACE/kubeconfig"
          echo "KUBECONFIG=$GITHUB_WORKSPACE/kubeconfig" >> "$GITHUB_ENV"
          chmod 600 "$GITHUB_WORKSPACE/kubeconfig"
          kubectl cluster-info

      # Use standalone Application CRD only (full install.yaml includes ApplicationSet CRD
      # which exceeds Kubernetes 262144-byte annotation limit and would fail).
      - name: Install Argo CD Application CRD only (for dry-run validation)
        run: |
          set -e
          kubectl apply -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/crds/application-crd.yaml
          kubectl wait --for=condition=Established crd/applications.argoproj.io --timeout=90s

      - name: Dry-run Application manifests
        run: |
          set -e
          kubectl apply --dry-run=client -f argocd-app.yaml
          for f in examples/evaluation/argocd-app.yaml examples/production/argocd-app.yaml \
            examples/eks/argocd-app.yaml examples/openshift/argocd-app.yaml examples/multi-source/argocd-app.yaml; do
            echo "Checking $f"
            kubectl apply --dry-run=client -f "$f"
          done
