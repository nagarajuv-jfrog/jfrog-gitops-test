# Validate YAML, Helm templates, and scripts on every push and PR.
# No cluster required; runs in ~1-2 min.
name: Validate

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  yaml:
    name: YAML lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          yamllint argocd-app.yaml customvalues.yaml
          yamllint examples/
          yamllint .github/

  helm:
    name: Helm template
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.13.0"

      - name: Add JFrog Helm repo
        run: |
          helm repo add jfrog https://charts.jfrog.io
          helm repo update jfrog

      - name: Template root (customvalues.yaml)
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            -f customvalues.yaml \
            --namespace jfrog-platform \
            --debug 2>/dev/null | head -100
          helm template jfrog-platform jfrog/jfrog-platform \
            -f customvalues.yaml \
            --namespace jfrog-platform \
            --validate

      - name: Template examples/evaluation
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            -f examples/evaluation/customvalues.yaml \
            --namespace jfrog-platform \
            --validate

      - name: Template examples/production
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            -f examples/production/customvalues.yaml \
            --namespace jfrog-platform \
            --validate

      - name: Template examples/openshift
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            -f examples/openshift/customvalues.yaml \
            --namespace jfrog-platform \
            --validate

      - name: Template examples/multi-source (base + sizing)
        run: |
          helm template jfrog-platform jfrog/jfrog-platform \
            -f examples/multi-source/customvalues.yaml \
            -f examples/multi-source/sizing/platform-medium.yaml \
            --namespace jfrog-platform \
            --validate

  scripts:
    name: Shell scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check script syntax (bash -n)
        run: |
          for f in scripts/*.sh; do
            bash -n "$f" || { echo "Syntax error in $f"; exit 1; }
          done
          echo "All scripts passed syntax check."

      - name: Run ShellCheck (optional)
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq shellcheck
          shellcheck scripts/*.sh || true
          # Don't fail on ShellCheck warnings; fix over time. Remove "|| true" to enforce.

  kubectl-dry-run:
    name: Argo CD manifests (kubectl dry-run)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kind and kubectl
        run: |
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/v0.22.0/kind-linux-amd64"
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/kind
          curl -Lo kubectl "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/kubectl

      - name: Create kind cluster
        run: |
          kind create cluster --wait 90s --image kindest/node:v1.28.0

      - name: Set kubeconfig
        run: |
          mkdir -p "$HOME/.kube"
          kind get kubeconfig > "$HOME/.kube/config"
          kubectl cluster-info

      - name: Install Argo CD Application CRD only (for dry-run validation)
        run: |
          kubectl apply -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/crds/application-crd.yaml
          kubectl wait --for=condition=Established crd/applications.argoproj.io --timeout=60s

      - name: Dry-run root argocd-app.yaml
        run: kubectl apply --dry-run=client -f argocd-app.yaml

      - name: Dry-run example Application manifests
        run: |
          for f in examples/*/argocd-app.yaml; do
            echo "Checking $f"
            kubectl apply --dry-run=client -f "$f"
          done
